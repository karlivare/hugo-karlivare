<script>
  // Runs only on pages where the gate partial is included
  (function () {
    var meta = document.createElement('meta');
    meta.name = 'robots';
    meta.content = 'noindex,nofollow';
    document.head.appendChild(meta);
  })();
</script>

<script>
  (function () {
    // Utility: sha256 hex in the browser
    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // Add noindex automatically if this page is protected (shared <head> is OK)
    function ensureNoIndex() {
      if (!document.querySelector('.password-gate')) return;
      if (document.querySelector('meta[name="robots"]')) return; // donâ€™t duplicate
      const meta = document.createElement('meta');
      meta.name = 'robots';
      meta.content = 'noindex,nofollow';
      document.head.appendChild(meta);
    }

    function buildGateUI(container) {
      const wrapper = document.createElement('div');
      wrapper.className = 'pg-wrap max-w-xl mx-auto py-16'; // swap for your classes

      const title = document.createElement('h1');
      title.className = 'pg-title text-3xl font-bold mb-4'; // swap for your classes
      // If your page already has an <h1> somewhere else, you can remove this line
      title.textContent = 'This page is password protected';

      const desc = document.createElement('p');
      desc.className = 'pg-desc mb-6';
      desc.textContent = 'Enter the password to continue.';

      const form = document.createElement('form');
      form.className = 'pg-form space-y-4';

      const label = document.createElement('label');
      label.className = 'block';

    //   const span = document.createElement('span');
    //   span.className = 'block mb-2';
    //   span.textContent = 'Password';

      const input = document.createElement('input');
      input.type = 'password';
      input.required = true;
      input.autocomplete = 'current-password';
      input.className = 'pg-input w-full border rounded-lg p-3'; // swap for your input classes
      input.placeholder = 'Enter password';

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.className = 'pg-button inline-flex items-center px-5 py-3 rounded-xl border'; // swap for your button classes
      btn.textContent = 'Unlock';

      const err = document.createElement('p');
      err.className = 'pg-error text-red-600 mt-2 hidden';
      err.textContent = 'Incorrect password. Try again.';

    //   label.appendChild(span);
      label.appendChild(input);
      form.appendChild(label);
      form.appendChild(btn);
      form.appendChild(err);

      wrapper.appendChild(title);
      wrapper.appendChild(desc);
      wrapper.appendChild(form);

      container.appendChild(wrapper);
      return { form, input, err };
    }

    async function initGate(container) {
      const expectedHash = (container.getAttribute('data-sha256') || '').trim();
      if (!expectedHash) return; // nothing to do

      // Per-page key (unique by path). If you want something else, change this.
      const pageKey = 'unlocked:' + location.pathname;

      // Already unlocked in this tab?
      if (sessionStorage.getItem(pageKey) === '1') {
        renderContent(container);
        return;
      }

      // Build UI
      const ui = buildGateUI(container);

      ui.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        ui.err.classList.add('hidden');

        const val = ui.input.value || '';
        const hash = await sha256Hex(val);
        if (hash === expectedHash) {
          sessionStorage.setItem(pageKey, '1');
          renderContent(container);
        } else {
          ui.err.classList.remove('hidden');
          ui.input.select();
        }
      });
    }

    function renderContent(container) {
    // 1) Find the template BEFORE clearing the container
    const tpl =
      container.querySelector('template[data-slot="content"]') ||
      document.querySelector('template[data-slot="content"]'); // optional fallback

    if (tpl && 'content' in tpl) {
      const frag = tpl.content.cloneNode(true);

      // 2) Now it's safe to clear the gate UI
      container.innerHTML = '';

      // 3) Inject the real content
      container.appendChild(frag);
      return;
    }

    // Fallback if no template exists: unhide a pre-hidden content wrapper
    const hidden = container.querySelector('[data-protected-content]');
    if (hidden) {
      hidden.style.display = '';
      container.innerHTML = '';
      container.appendChild(hidden);
    } else {
      container.textContent = 'Content unlocked.';
    }
  }

    // Boot
    document.addEventListener('DOMContentLoaded', function () {
      ensureNoIndex();
      document.querySelectorAll('.password-gate').forEach(initGate);
    });
  })();
</script>
