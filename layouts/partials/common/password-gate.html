<script>
  // Runs only on pages where the gate partial is included
  (function () {
    var meta = document.createElement('meta');
    meta.name = 'robots';
    meta.content = 'noindex,nofollow';
    document.head.appendChild(meta);
  })();
</script>

<script>
  (function () {
    // Utility: sha256 hex in the browser
    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // Add noindex automatically if this page is protected (shared <head> is OK)
    function ensureNoIndex() {
      if (!document.querySelector('.password-gate')) return;
      if (document.querySelector('meta[name="robots"]')) return; // don’t duplicate
      const meta = document.createElement('meta');
      meta.name = 'robots';
      meta.content = 'noindex,nofollow';
      document.head.appendChild(meta);
    }

    function buildGateUI(container) {
  // Gate-only wrapper so Bootstrap doesn’t leak into your case study
  const gateShell = document.createElement('div');
  gateShell.className = 'container d-flex flex-column align-items-center justify-content-center text-center';
  gateShell.style.minHeight = '65vh';

  const title = document.createElement('h1');
  title.className = 'h2 fw-bold mb-3';
  title.textContent = 'This page is password protected';

  const desc = document.createElement('p');
  desc.className = 'text-muted mb-4';
  desc.textContent = 'Enter the password to continue.';

  const form = document.createElement('form');
  form.className = 'w-100 d-flex flex-column align-items-center';

  // ✅ narrow wrapper: controls the width of the input group & button
  const narrow = document.createElement('div');
  narrow.className = 'w-100 mx-auto';
  narrow.style.maxWidth = '320px'; // <-- adjust to taste (e.g., 280, 360)

  // Input group with Show/Hide
  const group = document.createElement('div');
  group.className = 'input-group mb-3';

  const input = document.createElement('input');
  input.type = 'text'; // visible by default
  input.required = true;
  input.autocomplete = 'off';
  input.spellcheck = false;
  input.autocapitalize = 'off';
  input.inputMode = 'text';
  input.placeholder = 'Enter password';
  input.className = 'form-control text-center'; // center text inside input
  input.setAttribute('aria-label', 'Password');

  const toggle = document.createElement('button');
  toggle.type = 'button';
  toggle.className = 'btn btn-outline-secondary';
  toggle.textContent = 'Hide';
  toggle.addEventListener('click', () => {
    if (input.type === 'text') {
      input.type = 'password';
      toggle.textContent = 'Show';
    } else {
      input.type = 'text';
      toggle.textContent = 'Hide';
    }
    input.focus();
  });

  group.appendChild(input);
  group.appendChild(toggle);

  const btn = document.createElement('button');
  btn.type = 'submit';
  btn.className = 'btn btn-primary w-100'; // full width within the 320px wrapper
  btn.textContent = 'Unlock';

  const err = document.createElement('div');
  err.className = 'text-danger mt-2 d-none';
  err.textContent = 'Incorrect password. Try again.';

  narrow.appendChild(group);
  narrow.appendChild(btn);
  narrow.appendChild(err);
  form.appendChild(narrow);

  gateShell.appendChild(title);
  gateShell.appendChild(desc);
  gateShell.appendChild(form);

  container.appendChild(gateShell);
  return { form, input, err };
}


    async function initGate(container) {
      const expectedHash = (container.getAttribute('data-sha256') || '').trim();
      if (!expectedHash) return; // nothing to do

      // Per-page key (unique by path). If you want something else, change this.
      const pageKey = 'unlocked:' + location.pathname;

      // Already unlocked in this tab?
      if (sessionStorage.getItem(pageKey) === '1') {
        renderContent(container);
        return;
      }

      // Build UI
      const ui = buildGateUI(container);

      ui.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        ui.err.classList.add('hidden');

        const val = ui.input.value || '';
        const hash = await sha256Hex(val);
        if (hash === expectedHash) {
          sessionStorage.setItem(pageKey, '1');
          renderContent(container);
        } else {
          ui.err.classList.remove('hidden');
          ui.input.select();
        }
      });
    }

    function renderContent(container) {
  // 1) grab template first
  const tpl = container.querySelector('template[data-slot="content"]');
  if (tpl && 'content' in tpl) {
    const frag = tpl.content.cloneNode(true);
    // 2) nuke everything inside the gate
    container.innerHTML = '';
    // 3) inject your real content only (no Bootstrap gate shell remains)
    container.appendChild(frag);
  } else {
    container.textContent = 'Content unlocked.';
  }
}

    // Boot
    document.addEventListener('DOMContentLoaded', function () {
      ensureNoIndex();
      document.querySelectorAll('.password-gate').forEach(initGate);
    });
  })();
</script>
